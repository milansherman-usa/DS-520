---
title: "Final Project Step 3"
author: "Milan Sherman"
date: "2/27/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(naniar)
```
# Introduction

Using data to increase a sports team's odds of winning has become standard in professional sports over the last 20 years.  In the early 2000s, the Oakland A's were early adopters, or even inventors of this approach to assembling a competitive baseball team as chronicled in the book (and movie) Moneyball (2011). While the strategy is not new, I am interested in identifying baseball metrics that are predictive of winning.  Given the amount of money that is generated by professional sports, the ability to gain a competitive edge via data is crucial.  In the current context, the ubiquity of leveraging data in sports has perhaps changes this approach from one of opportunity to a necessity in order to not lose ground on competitors.


# Research Questions

My research question evolved and came into focus as I became more familiar with my datasets.  I found that the datasets that I'd chosen were best suited to generating offensive metrics, and that offensive metrics are generally related more to runs scored than winning or losing in the research that I'd done.  I did not want to lose sight of winning or losing, but decided to first relate my metrics to runs scored as it makes sense that these metrics would be much more predictive of runs scored.  In the end, I focused in the following research question:
*What batting metrics are most highly correlated with runs scored?  Which metrics are most predictive of winning or losing?  
 

# Approach

At the beginning of my project, I had identified batting average, on-base percentage, and slugging percentage as important offensive metrics to explore, but during my research I stumbled upon a lesser known metric with a lot of promise: base-out percentage. The inclusion of this metric made the analysis particularly interesting, as in theory it seemed to capture all of the important information needed to predict runs.  Each of these metrics is defined as follows:
*Batting Average: the proportion of at-bats that result in a hit.  Walks are not considered an at-bat, and therefore are removed from consideration in this metric.
*Slugging Percentage: a weighted batting average, weighting each hit according to the number of bases it nets.
*On-base Percentage:  the proportion of plate appearances that resulted in the hitter ending up on base
*Base-out Percentage: the ration of bases a player nets by any means to the number of outs they generate by any means

My approach was to generate these metrics by team by game and use them to predict runs scored and winning or losing.  Two of my three datasets were unaggregated, and thus needed to be cleaned and transformed in order to generate these metrics at that level.  This was a time consuming step, as it required an in-depth understanding of what data was contained in the dataset in order to transform it into the above metrics.  That step done, the analysis was focused on the following steps:
1. Understanding the relationship between each of these metrics and runs scored within each of the datasets via scatterplots and Pearson's correlation coefficient
2. Creating a simple linear regression model using runs scored  and each of these hitting metrics
3. Creating a simple logistic regression model using win/lose and each of these hitting metrics

To be clear about my question is focused on comparing the predictive power of these metrics rather than finding the most accurate model.  Putting all of these metrics into a single model would likely result in a very accurate model, but would not lead to an actionable insight in the sense that we would not know what to prioritize.  If we want to assemble a team with the best chance of winning we would like to know if we should value batting average, slugging percentage, on-base percentage, or base-out percentage.  It is for this reason that the analysis considers each of these potential predictors of runs scored and winning/losing separately.

```{r}
hitting <- read.csv("C:/Users/misherman/DS-520/Baseball Datasets/mlbbatting1901-2021.csv")
game_logs <- read.csv("C:/Users/misherman/DS-520/Baseball Datasets/game_logs.csv")
moneyball <- read.csv("C:/Users/misherman/DS-520/Baseball Datasets/baseball.csv")

```

# Analysis

The analysis is organized by dataset, and finding are synthesized in the Insights section.  In this section I analyze the relationship between the number of runs scored and various hitting metrics, including batting average, slugging percentage, on-base percentage, and base-out percentage.  For each metric, I generate a scatterplot, compute the Pearson Correlation Coefficient, and generate a linear model.  Finally, I generate a logistic model using each metric to see how predictive of winning or losing each metric is.

## Hitting Stats 1901-2021

```{r, warning=FALSE, message =FALSE , echo=FALSE}
by_game_pct <- hitting %>% 
  mutate(date2 = str_replace_all(Date, "-", ""),
         result1 = str_replace_all(Rslt, " ", ""),
         result = str_replace_all(result1, "-", ""),
         outcome = substr(Rslt, 1, 1),
         game_team_id = paste0(date2, Tm, Opp, result)) %>% 
  filter(outcome != 'T') %>% 
  group_by(game_team_id, Date, Tm, Opp, outcome) %>% 
  summarise(PA = sum(PA),
            AB = sum(AB),
            H = sum(H),
            R = sum(R),
            B2 = sum(X2B),
            B3 = sum(X3B),
            HR = sum(HR),
            B1 = H - (B2 + B3 + HR),
            RBI = sum(RBI),
            BB = sum(BB),
            SO = sum(SO),
            HBP = sum(HBP),
            SH = sum(SH),
            SF = sum(SF, na.rm = T),
            GDP = sum(GDP, na.rm = T),
            SB = sum(SB),
            CS = sum(CS, na.rm = T),
            bases = B1 + 2*B2 + 3*B3 + 4*HR, 
            total_bases = bases + BB + HBP + SH + SF + SB,
            outs = (AB - H) + SH + SF + CS + GDP) %>% 
  mutate(BA = H/AB,
         Slug = bases/AB,
         OBP = (H + BB + HBP)/(AB + BB + HBP + SF),
         BOP = total_bases/outs)

head(by_game_pct)

```


### Batting Average
```{r, echo=FALSE}
ggplot(by_game_pct, aes(x = BA,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of batting average",
       x = "Game batting average",
       y = "Runs scored in the game",
       caption = "Source: Hitting Statistics 1901-2021")

batting_average <-  cor(by_game_pct$BA, by_game_pct$R)

hit_BA_lm <- lm(R ~ BA, data = by_game_pct)

summary(hit_BA_lm)

# win_BA_glm <- glm(outcome ~ BA, data = by_game_pct, family = "binomial" )
```
print(paste("The Pearson correlation coefficient between batting average and runs scored is", batting_average))

### Slugging Percentage
```{r, echo=FALSE}
ggplot(by_game_pct, aes(x = Slug,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of slugging percentage",
       x = "Game slugging percentage",
       y = "Runs scored in the game",
       caption = "Source: Hitting Statistics 1901-2021")

slugging_pct <- cor(by_game_pct$Slug, by_game_pct$R)
hit_slug_lm <- lm(R ~ Slug, data = by_game_pct)
summary(hit_slug_lm)
```
print(paste("The Pearson correlation coefficient between Slugging percentage and runs scored is", slugging_pct))

### On-base Percentage
```{r, echo=FALSE}
ggplot(by_game_pct, aes(x = OBP,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of on-base percentage",
       x = "Game on-base percentage",
       y = "Runs scored in the game",
       caption = "Source: Hitting Statistics 1901-2021")

on_base_pct <- cor(by_game_pct$OBP, by_game_pct$R)
hit_OBP_lm <- lm(R ~ OBP, data = by_game_pct)
summary(hit_OBP_lm)
```
print(paste("The Pearson correlation coefficient between on-base percentage and runs scored is", on_base_pct ))

### Base-out Percentage
```{r, echo=FALSE}
ggplot(by_game_pct, aes(x = BOP,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of base-out percentage",
       x = "Game base-out percentage",
       y = "Runs scored in the game",
       caption = "Source: Hitting Statistics 1901-2021")
base_out_pct <- cor(by_game_pct$BOP, by_game_pct$R)
hit_BOP_lm <- lm(R ~ BOP, data = by_game_pct)
summary(hit_BOP_lm)
```

print(paste("The Pearson correlation coefficient between base-out percentage and runs scored is",base_out_pct ))


# MLB Game Logs
```{r, warning=FALSE, message = FALSE, echo=FALSE}
game_log <-  game_logs %>% 
  filter(acquisition_info == 'Y' & forefeit == '') %>% 
  mutate(date2 = str_replace_all(date, "-", ""),
         game_id = paste0(date2, number_of_game)) %>% 
  dplyr::select(game_id,
                date,
                v_name,
                v_score,
                v_at_bats,
                v_hits,
                v_doubles,
                v_triples,
                v_homeruns,
                v_rbi,
                v_sacrifice_hits,
                v_sacrifice_flies,
                v_hit_by_pitch,
                v_walks,
                v_stolen_bases,
                v_caught_stealing,
                v_grounded_into_double,
                h_name,
                h_score,
                h_at_bats,
                h_hits,
                h_doubles,
                h_triples,
                h_homeruns,
                h_rbi,
                h_sacrifice_hits,
                h_sacrifice_flies,
                h_hit_by_pitch,
                h_walks,
                h_stolen_bases,
                h_caught_stealing,
                h_grounded_into_double) 


visitor <- game_log %>% 
  dplyr::select(game_id,
                date,
                v_name,
                v_score,
                v_at_bats,
                v_hits,
                v_doubles,
                v_triples,
                v_homeruns,
                v_rbi,
                v_sacrifice_hits,
                v_sacrifice_flies,
                v_hit_by_pitch,
                v_walks,
                v_stolen_bases,
                v_caught_stealing,
                v_grounded_into_double) %>% 
  rename(team = v_name,
                R = v_score,
                AB = v_at_bats,
                H = v_hits,
                B2 = v_doubles,
                B3 = v_triples,
                HR= v_homeruns,
                RBI= v_rbi,
                SH = v_sacrifice_hits,
                SF = v_sacrifice_flies,
                HBP = v_hit_by_pitch,
                BB= v_walks,
                SB = v_stolen_bases,
                CS = v_caught_stealing,
                GDP = v_grounded_into_double) %>% 
  mutate(B1 = H - (B2 + B3 + HR))

visitor <- visitor %>% 
  naniar::replace_with_na(replace = list(CS = -1)) %>%
  naniar::replace_with_na(replace = list(GDP = -1)) %>% 
  naniar::replace_with_na(replace = list(B2 = -1)) %>% 
  naniar::replace_with_na(replace = list(B3 = -1)) %>% 
  naniar::replace_with_na(replace = list(HR = -1)) %>% 
  naniar::replace_with_na(replace = list(RBI = -1)) %>% 
  naniar::replace_with_na(replace = list(SF = -1)) %>% 
  naniar::replace_with_na(replace = list(BB = -1)) %>% 
  naniar::replace_with_na(replace = list(SB = -1))

home <- game_log %>% 
  dplyr::select(game_id,
                date,
                h_name,
                h_score,
                h_at_bats,
                h_hits,
                h_doubles,
                h_triples,
                h_homeruns,
                h_rbi,
                h_sacrifice_hits,
                h_sacrifice_flies,
                h_hit_by_pitch,
                h_walks,
                h_stolen_bases,
                h_caught_stealing,
                h_grounded_into_double) %>% 
    rename(team = h_name,
                R = h_score,
                AB = h_at_bats,
                H = h_hits,
                B2 = h_doubles,
                B3 = h_triples,
                HR= h_homeruns,
                RBI= h_rbi,
                SH = h_sacrifice_hits,
                SF = h_sacrifice_flies,
                HBP = h_hit_by_pitch,
                BB= h_walks,
                SB = h_stolen_bases,
                CS = h_caught_stealing,
                GDP = h_grounded_into_double) %>% 
  mutate(B1 = H - (B2 + B3 + HR))

home <- home %>% 
  naniar::replace_with_na(replace = list(CS = -1)) %>%
  naniar::replace_with_na(replace = list(GDP = -1)) %>% 
  naniar::replace_with_na(replace = list(B2 = -1)) %>% 
  naniar::replace_with_na(replace = list(B3 = -1)) %>% 
  naniar::replace_with_na(replace = list(HR = -1)) %>% 
  naniar::replace_with_na(replace = list(RBI = -1)) %>% 
  naniar::replace_with_na(replace = list(SF = -1)) %>% 
  naniar::replace_with_na(replace = list(BB = -1)) %>% 
  naniar::replace_with_na(replace = list(SB = -1))


all_games <- bind_rows(visitor, home) %>% 
  mutate(bases = B1 + 2*B2 + 3*B3 + 4*HR, 
         total_bases = bases + BB + HBP + SH + SF + SB,
         outs = (AB - H) + SH + SF + CS + GDP,
         BA = H/AB,
         Slug = bases/AB,
         OBP = (H + BB + HBP)/(AB + BB + HBP + SF),
         BOP = total_bases/outs)

head(all_games)
```

### Batting Average
```{r, echo=FALSE}
ggplot(all_games, aes(x = BA,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of batting average",
       x = "Game batting average",
       y = "Runs scored in the game",
       caption = "Source: MLB Game Logs")

batting_average <-  cor(all_games$BA, all_games$R)

gl_BA_lm <- lm(R ~ BA, data = all_games)
summary(gl_BA_lm)

```
print(paste("The Pearson correlation coefficient between batting average and runs scored is", batting_average ))

### Slugging Percentage
```{r, echo=FALSE}
ggplot(all_games, aes(x = Slug,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of slugging percentage",
       x = "Game slugging percentage",
       y = "Runs scored in the game",
       caption = "Source: MLB Game Logs")

sluggin_pct <- cor(all_games$Slug, all_games$R)
gl_slug_lm <- lm(R ~ Slug, data = all_games)
summary(gl_slug_lm)

```
print(paste("The Pearson correlation coefficient between slugging percentage and runs scored is", slugging_pct ))

### On-base Percentage
```{r, echo=FALSE}
ggplot(all_games, aes(x = OBP,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of on-base percentage",
       x = "Game on-base percentage",
       y = "Runs scored in the game",
       caption = "Source: MLB Game Logs")

on_base_pct <- cor(all_games$OBP, all_games$R)

gl_OBP_lm <- lm(R ~ OBP, data = all_games)
summary(gl_OBP_lm)
```
print(paste("The Pearson correlation coefficient between on-base percentage and runs scored is", on_base_pct ))

### Base-out Percentage
```{r, echo=FALSE}
ggplot(all_games, aes(x = BOP,
                        y = R)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of base-out percentage",
       x = "Game base-out percentage",
       y = "Runs scored in the game",
       caption = "Source: MLB Game Logs")

base_out_pct <- cor(all_games$BOP, all_games$R)

gl_BOP_lm <- lm(R ~ BOP, data = all_games)
summary(gl_BOP_lm)

```
print(paste("The Pearson correlation coefficient between base-out percentage and runs scored is", base_out_pct ))


## Moneyball

This dataset is different than the previous datasets in that it is already aggregated by team by season.  Thus, the analysis is slightly different in the following ways:

1.  It is not possible to recover the number of outs and bases from this aggregated data, so I cannot compute base-out percentage.  Since batting average, slugging percentage, and on-base percentage are in this dataset, those the metrics I will use
2.  This data is aggregated at the season level, and contains the number of runs scored over the course of the season, as well as the number of wins.  So the analysis will focus on the relationship between runs scored and these metrics, as the previous analyses did, but instead of using a logistic model to relate them to the binary outcome of winning or losing, I will create simple linear regression models to examine the relationship between wins and each batting metric.


### Batting Average
```{r, echo=FALSE}
ggplot(moneyball, aes(x = BA,
                        y = RS)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of batting average",
       x = "Season batting average",
       y = "Runs scored in the season",
       caption = "Source: Moneyball Dataset")

batting_average_RS <-  cor(moneyball$BA, moneyball$RS)

mb_BA_RS_lm <- lm(RS ~ BA, data = moneyball)

summary(mb_BA_RS_lm)

```
print(paste("The Pearson correlation coefficient between batting average and runs scored is", batting_average_RS))

```{r, echo=FALSE}
ggplot(moneyball, aes(x = BA,
                        y = W)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Wins as function of batting average",
       x = "Season batting average",
       y = "Wins",
       caption = "Source: Moneyball Dataset")

batting_average_W <-  cor(moneyball$BA, moneyball$W)

mb_BA_W_lm <- lm(W ~ BA, data = moneyball)

summary(mb_BA_W_lm)

```
print(paste("The Pearson correlation coefficient between batting average and wins is", batting_average_W))

### Slugging Percentage
```{r, echo=FALSE}
ggplot(moneyball, aes(x = SLG,
                        y = RS)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of slugging percentage",
       x = "Season slugging percentage",
       y = "Runs scored in the season",
       caption = "Source: Moneyball Dataset")

slugging_pct_RS <- cor(moneyball$SLG, moneyball$RS)


mb_slug_RS_lm <- lm(RS ~ SLG, data = moneyball)

summary(mb_slug_RS_lm)

```
print(paste("The Pearson correlation coefficient between slugging percentage and runs scored is", slugging_pct_RS))

```{r, echo=FALSE}
ggplot(moneyball, aes(x = SLG,
                        y = W)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Wins as function of slugging percentage",
       x = "Season slugging percentage",
       y = "wins",
       caption = "Source: Moneyball Dataset")

slugging_pct_W <- cor(moneyball$SLG, moneyball$W)

mb_slug_W_lm <- lm(W ~ SLG, data = moneyball)

summary(mb_slug_W_lm)

```
print(paste("The Pearson correlation coefficient between slugging percentage and wins is", slugging_pct_W))

### On-base Percentage
```{r, echo=FALSE}
ggplot(moneyball, aes(x = OBP,
                        y = RS)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Runs scored as function of on-base percentage",
       x = "Season on-base percentage",
       y = "Runs scored in the season",
       caption = "Source: Moneyball Dataset")

on_base_pct_RS <- cor(moneyball$OBP, moneyball$RS)

mb_OBP_RS_lm <- lm(RS ~ OBP, data = moneyball)

summary(mb_OBP_RS_lm)
```
print(paste("The Pearson correlation coefficient between on-base percentage and runs scored is", on_base_pct_RS))


```{r, echo=FALSE}
ggplot(moneyball, aes(x = OBP,
                        y = W)) +
  geom_point() +
  geom_jitter() +
  labs(title = "Wins as function of on-base percentage",
       x = "Season on-base percentage",
       y = "Wins",
       caption = "Source: Moneyball Dataset")

on_base_pct_W <- cor(moneyball$OBP, moneyball$W)

mb_OBP_W_lm <- lm(W ~ OBP, data = moneyball)

summary(mb_OBP_W_lm)
```
print(paste("The Pearson correlation coefficient between on-base percentage and wins is", on_base_pct_W))


## Limitations

There are other offensive metric that could be included in this analysis that I was not aware of until after I'd completed my data transformation, such as OPS, which is on-base percentage plus slugging percentage.  Furthermore, runs scored is only half of winning.  No matter how many runs a team scores, they will still lose if their opponent scores more runs.  Thus, to try to use these hitting metrics to predict winning or losing, it is likely insufficient to relate a metric like batting average to winning or losing a game.  That is, a team's batting average in a game may not be predictive of winning or losing, but rather the team's batting average relative their opponent's batting average in the same game.  Creating metrics for the differences between team hitting metrics for a game would like be more predictive of winning or losing, as it takes into account how well the other team batted as well. 

However, while this would be an interesting analysis, it is likely less actionable as there is not a single controllable aspect of the game that influences how both teams hit in a game.  A separate analysis of defensive metrics, especially pitching, is likely needed in order to find actionable insights that would influence winning or losing.  Pitchers are the most valued players in the game due to their ability to influence the number of runs scored by an opponent.  Identifying a metric like base-out percentage for pitchers could lead to more actionable insights. 

A more minor issue is that there should be either 24 or 27 outs per game.  In general, a team gets three outs per inning for nine innings.  However, when the home team is winning in the bottom of the ninth inning, the game is over since the visitiing team has no more at bats and thus the outcome of the game will not be changed by the home team's at bats.  The issue, is that when calculating outs in my data, I found a number of instances where the number of outs was not 24 or 27, but 25, 26, or 28.  

## Concluding Remarks

Baseball has long been called a game of numbers due to many statistics that are tracked and computed for every aspect of the game.  While base-out percentage is the most predictive metric of runs scored, given the current state of baseball analytics, there must be some reason that it is relatively unknown and/or used. Indeed, opportunities to exploit an undervalued metric like on-base percentage are likely impossible in baseball today. Rather, understanding how to value players based on these various metrics is likely a focus of current baseball analytics, although this is just a hypothesis.  That is, understanding the relationship between winning and earnings, and the relationship between a variety of metrics and winning would form a basis, in conjunction with market value for similar players, for contract negotiations.  I recently heard of a European soccer player who hired a team of data scientists to evaluate his financial impact to his team and used it as basis for negotiating a new contract.  It may be that soccer is behind baseball in terms of its analytics maturity, as I would think that every general manager in baseball has already done this analysis for each of his players, if not for every player in the league.
